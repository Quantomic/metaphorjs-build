'use strict';var MetaphorJs={},fs=require("fs"),isFile=function(d){return fs.existsSync(d)&&fs.lstatSync(d).isFile()},isDir=function(d){return fs.existsSync(d)&&fs.lstatSync(d).isDirectory()},path=require("path"),getFileList=function(d,a){var c,b,f=0,g=[];"*"==d.substr(d.length-1)&&f++;"**"==d.substr(d.length-2)&&f++;f&&(d=d.substr(0,d.length-(f+1)));d=path.normalize(d);var e=function(d){c=fs.readdirSync(d);c.forEach(function(c){b=path.normalize(d+"/"+c);isFile(b)?a?"string"==typeof a&&path.extname(b).substr(1)==
a?g.push(b):path.extname(b).substr(1).match(a)&&g.push(b):g.push(b):isDir(b)&&1<f&&e(b)})};0<f||isDir(d)?e(d):g=[d];return g},JsonFile=function(){var d=function(a){this.path=path.normalize(a);this.base=path.dirname(this.path)+"/";this.build={};this.test=[];this.push=[];this.mixin={};a=require(this.path);for(var b in a)this[b]=a[b]};d.prototype={path:null,base:null,target:null,compile:!0,test:null,version:null,push:null,mixin:null,build:null};var a={};d.get=function(c){c=path.normalize(c);a[c]||(a[c]=
new d(c));return a[c]};return d}(),File=function(){var d=/'use strict'|"use strict";?/g,a=/([^\s]+)\s*=\s*require\(['|"]([^)]+)['|"]\)\s*,?/,c=/[^=\s]?\s*(require\(['|"]([^)]+)['|"]\);?)/,b=/var[\s|,]*;/g,f=/var\s+/g,g=/,\s*;/g,e={},k=function(b){e[b]||(e[b]=new l(b));return e[b]},l=function(b,a){this.base=path.dirname(b)+"/";this.path=b;this.as=[];this.requires=[];this.requiredBy=[];this.reqNames={};this.temporary=a;this.process();this.findUnused()};l.prototype={base:null,path:null,content:"",as:null,
requires:null,requiredBy:null,processed:!1,reqNames:null,temporary:!1,getContent:function(b){var a=this.content,c=this.as.slice(),f,h;b=b||{};b.keepExports||-1==a.indexOf("module.exports")||(b.returnExports?a=a.replace(/module\.exports\s*=/,"return"):(b=(h=/module\.exports\s*=\s*([^(\['"+. ]+)\s*;/.exec(a))?h[1]:null,h=(h=/module\.exports\s*=\s*function\s+([^( ]+)/i.exec(a))?h[1]:null,b&&-1!=(f=c.indexOf(b))&&c.splice(f,1),b&&0==c.length?a=a.replace(/module\.exports\s*=\s*[^;]+;/,""):0==c.length||
h&&1==c.length&&c[0]==h?a=a.replace(/module\.exports\s*=\s*/,""):1<c.length?(a="var "+c.join(", ")+";\n"+a,a=a.replace("module.exports",c.join(" = "))):a=a.replace("module.exports","var "+c[0])),a=a.replace(d,""));return a},process:function(){var d=fs.readFileSync(this.path).toString(),f=this.base,e=0,l=process.env.METAPHORJS_PATH,h,p;if(!this.processed){for(;p=a.exec(d.substr(e));)if(h=p[2],-1==h.indexOf(".js"))e+=p.index+h.length;else{if(isFile(path.normalize(f+h)))h=path.normalize(f+h);else if(isFile(l+
"/"+h))h=l+"/"+h;else throw h+" required in "+this.path+" does not exist";d=d.replace(p[0],"");this.reqNames[p[1]]=h;h=k(h);h.addAs(p[1]);if(h.doesRequire(this.path))throw"Two files require each other: "+h.path+" <-> "+this.path;this.addRequired(h.path);h.addRequiredBy(this.path)}d=d.replace(b,"");d=d.replace(g,";");for(e=0;p=c.exec(d.substr(e));)if(h=p[2],-1==h.indexOf(".js"))e+=h.length;else{d=d.replace(p[1],"");h=path.normalize(f+h);if(!isFile(h))throw h+" required in "+this.path+" does not exist";
h=k(h);if(h.doesRequire(this.path))throw"Two files require each other: "+h.path+" <-> "+this.path;this.addRequired(h.path);h.addRequiredBy(this.path)}this.content=d;this.processed=!0}},doesRequire:function(a){return-1!=this.requires.indexOf(a)},addRequired:function(a){-1==this.requires.indexOf(a)&&this.requires.push(a)},addRequiredBy:function(a){this.requiredBy.push(a)},addAs:function(a){"*"==a&&(a=path.basename(this.path,".js"));-1==this.as.indexOf(a)&&this.as.push(a)},findUnused:function(){var a=
this.content,b,c;for(b in this.reqNames)c=new RegExp("[^a-zA-Z0-9]"+b+"[^a-zA-Z0-9]"),a.match(c)||console.log("Unused requirement "+b+" in "+this.path)}};l.getOrCreate=k;l.exists=function(a){return!!e[a]};l.get=function(a){return e[a]};l.removeDupReqs=function(c){for(var d,e,k=0,h={};d=a.exec(c.substr(k));)e=d[1],h[e]?c=c.substr(0,k+d.index)+c.substr(k+d.index+d[0].length):(h[e]=!0,k+=d.index+d[0].length);c=c.replace(b,"");c=c.replace(g,";");return c=c.replace(f,"var ")};return l}(),firstFile=function(){var d=
arguments.length,a,c,b;for(a=0;a<d;a++)if(c=arguments[a],-1!=(b=c.indexOf("*"))&&(c=c.substr(0,b),c=c.split("/"),c.pop(),c=c.join("/")),isFile(c))return arguments[a];return arguments[0]},Build=function(d,a){this.name=a;this.jsonFile=d;this.files=[];this.fileOptions={};var c="string"==typeof a?d.build[a]||d.mixin[a]:a,b;if(c){for(b in c)this[b]=c[b];this.collectFiles(c);this.prepareBuildList()}};
Build.prototype={name:null,jsonFile:null,files:null,buildList:null,wrap:!1,target:"",specificTarget:null,compile:!0,allOmits:null,allReplaces:null,fileOptions:null,collectFiles:function(d){var a={},c=[],b={},f={},g=function(b,c,d){if(a[b]){var f=a[b];if(f){var e,k;for(e in c)"undefined"==typeof f[e]?f[e]=c[e]:"as"==e&&(k=f[e],"string"==typeof k&&(f[e]=[k]),f[e].push(c[e]))}else a[b]=c}else a[b]=c||{};d&&(a[b].temporary=!0)},e=function(a,b,c){b=a.build[b]||a.mixin[b];var d=b.extension||"js",d="/tmp/mjs-build-tmp-"+
(new Date).getTime()+"."+d,f=require,e="undefined"==typeof e?f("./Builder.js"):e;b.specificTarget=d;(new e(b,a)).build();g(d,c)},k=function(a,c,d){d=a.files||[];var e=a.omit||[],g=a.replace||[],m=c.base,n=a.extension||"js",s=process.env.METAPHORJS_PATH;(a.mixins||[]).forEach(function(a){if("string"==typeof a)k(c.mixin[a]||{},c);else{var b=JsonFile.get(firstFile(m+a[0],s+"/"+a[0]));k(b.mixin[a[1]]||{},b)}});e.forEach(function(a){getFileList(firstFile(m+a,s+"/"+a),n).forEach(function(a){b[a]=!0})});
g.forEach(function(a){f[firstFile(path.normalize(m+a[0]),s+"/"+a[0])]=firstFile(path.normalize(m+a[1]),s+"/"+a[1])});d.forEach(function(a){l(a,c)})},l=function(a,b){"string"==typeof a&&(a=[a]);var c=a[0],d=process.env.METAPHORJS_PATH,f;-1==c.indexOf(".")&&-1==c.indexOf("*")?a[1]?e(b,c,a[1]):k(b.mixin[c]||{},b):".json"==path.extname(c)?(c=JsonFile.get(firstFile(b.base+c,d+"/"+c)),a[2]?e(c,a[1],a[2]):k(c.mixin[a[1]]||{},c)):(f=path.extname(c).substr(1)||b.extension||"js",c=getFileList(firstFile(b.base+
c,d+"/"+c),f),c.forEach(function(b){g(b,a[1])}))};k(d,this.jsonFile);for(var m in a){for(;f[m];)m=f[m];b[m]||(c.push([m,a[m]||{}]),a[m]&&(this.fileOptions[m]=a[m]))}this.allOmits=b;this.allReplaces=f;this.files=c},prepareBuildList:function(){var d=[],a={},c=[],b=this.allOmits,f=this.allReplaces,g=function(e){c.push(e.path);if(50<c.length)throw console.log(c),"Recursive requirement";e.requires.forEach(function(a){for(;f[a];)a=f[a];b[a]||g(File.get(a))});a[e.path]||(a[e.path]=!0,d.push(e.path));c.pop()};
this.files.forEach(function(a){g(File.getOrCreate(a[0]))});var e=this.fileOptions;d.forEach(function(a){var b=e[a],c;b&&b.as&&(c=File.getOrCreate(a),"string"==typeof b.as?c.addAs(b.as):b.as.forEach(function(a){c.addAs(a)}))});this.buildList=d}};
var eachProject=function(d){var a=process.cwd(),c=fs.readdirSync(a),b,f,g=function(c){c=a+"/"+c;b=c+"/metaphorjs.json";isDir(c)&&isFile(b)&&(f=require(b),d(f,b))};g("");c.forEach(g)},toString=Object.prototype.toString,undf=void 0,varType=function(){var d={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(a){if(!a){if(null===a)return 6;if(a===undf)return 7}var c=d[toString.call(a)];
return c===undf?-1:1==c&&isNaN(a)?8:c}}();function isArray(d){return"object"==typeof d&&5===varType(d)}var child=require("child_process"),Promise=require("metaphorjs-promise"),Builder=function(d,a){if(!(isFile(a)||a instanceof JsonFile))throw a+" not found";this.jsonFile=a instanceof JsonFile?a:JsonFile.get(a);this.projectFile=a instanceof JsonFile?a.path:a;this.bld=new Build(this.jsonFile,d)};
Builder.prototype={jsonFile:null,bld:null,projectFile:null,build:function(){var d=this.bld;d.files.length&&d.target&&this.concat()},concat:function(){var d=this,a=d.bld,c=a.specificTarget||path.normalize(d.jsonFile.base+a.target),b="",f,g;console.log("Building "+path.basename(c));isFile(c)&&fs.unlinkSync(c);if(a.require){var e=a.require,k;for(k in e){var l=e[k];if("string"==typeof l)b+="var "+l+" = require('"+k+"');\n";else{var m="var "+l.as+" = require('"+k+"')",q=l.args?l.args.join(", "):"";l.call?
m=!0===l.call?m+("("+q+")"):m+("."+l.call+"("+q+")"):q&&(m+="("+q+")");b+=m+";\n"}}}a.prepend&&a.prepend.forEach(function(a){a=path.normalize(d.jsonFile.base+a);b+=fs.readFileSync(a).toString();b+="\n"});a.buildList.forEach(function(c){if(!File.exists(c))throw c+" was not resolved";f=File.get(c);g=a.fileOptions[c];b+=f.getContent(g);b+="\n";g&&g.temporary&&fs.unlinkSync(f.path)});if(a.expose){var t={},r=a.exposeIn||"MetaphorJs";t[r]=!0;if("all"==a.expose)d.collectNames().forEach(function(c){a.exposeSkip&&
-1!=bls.exposeSkip.indexOf(c)||c!=r&&(b+=r+"['"+c+"'] = "+c+";\n")});else{var h,p;a.expose.forEach(function(a){"string"==typeof a?b+=r+"['"+a+"'] = "+a+";\n":(isArray(a)?(h=a[0],p=a[2]||a[1],a=a[1]):(h=a.ns||r,p=a.as||a.name,a=a.name),t[h]||(b+=h+" || ("+h+" = {});\n"),b+=h+"['"+p+"'] = "+a+";\n")})}}a.append&&a.append.forEach(function(a){a=path.normalize(d.jsonFile.base+a);b+=fs.readFileSync(a).toString();b+="\n"});a.global&&(b+="typeof global != \"undefined\" ? (global['MetaphorJs'] = MetaphorJs) : (window['MetaphorJs'] = MetaphorJs);\n");
a.exports&&(b=a.wrap?b+("return "+a.exports+";\n"):b+("module.exports = "+a.exports+";\n"));a.returns&&(b+="return "+a.returns+";\n");if(a.define){e=a.define.deps;k=a.define.return;var l='define("'+a.define.name+'", ',m="\n});\n",q=[],u=[],n;if(e){for(n in e)q.push("'"+n+"'"),u.push(e[n]);l+="["+q.join(", ")+"], ";l+="function("+u.join(", ")+") {\n"}else l+="function() {\n";k&&(m="\nreturn "+k+";"+m);b=l+b+m;b+="\n"}b=File.removeDupReqs(b);a.wrap&&(n=a.wrap,"object"!=typeof n&&(n={}),e="",n.args&&
(e=n.args.join(", ")),k=n.name||"",b=(n.start||n.deferred?"function "+k+"("+e+') {\n"use strict";\n':"(function("+e+'){\n"use strict";\n')+b+(n.end||n.deferred?"\n};":"\n}("+e+"));"),a.exports||n.exported)&&(b="module.exports = "+b);fs.writeFileSync(c,b)},compile:function(d){var a=this.bld,c=path.normalize(this.jsonFile.base+a.target),b=c.replace(/\.js$/,".min.js"),f=[],g;isFile(b)&&fs.unlinkSync(b);console.log("Compiling "+path.basename(b));g=fs.createWriteStream(b);f.push(c);f.push("--language_in=ECMASCRIPT5_STRICT");
a.compileAdvanced&&f.push("--compilation_level=ADVANCED");a.compileSourceMap&&f.push("--create_source_map="+b+".map");a=child.spawn("ccjs",f);a.stderr.pipe(process.stderr);a.stdout.pipe(g);a.on("exit",function(a){d?d(a):process.exit(a)});a.on("error",function(a){console.log(a)})},collectNames:function(){var d=[],a={};this.bld.buildList.forEach(function(c){File.getOrCreate(c).as.forEach(function(c){a[c]||(a[c]=!0,d.push(c))})});return d}};
var eachBuild=function(d){eachProject(function(a,c){var b=a.build,f;if(b)for(f in b)d(b[f],c,f)})};Builder.build=function(d,a){a||(a=process.cwd()+"/metaphorjs.json");var c=[];if(d)c.push(d);else{var b=require(a).build;if(b)for(var f in b)b[f].auto&&c.push(f)}c.forEach(function(c){(new Builder(c,a)).build()})};Builder.buildAll=function(d){var a;eachBuild(function(c,b,f){if(!d||c.auto)a=new Builder(f,b),a.build()})};
Builder.compile=function(d,a){a||(a=process.cwd()+"/metaphorjs.json");if(!d)throw"Must specify build. Or use mjs-compile --all";var c=new Promise,b=new Builder(d,a);b.build();b.compile(function(){c.resolve()});return c};
Builder.compileAll=function(d,a){var c,b=[],f=new Promise,g,e=function(k){0!=k?(f.reject(g[1]+" failed compiling with code "+k),d||process.exit(k)):(g=b.shift())?(c=new Builder(g[0],g[1]),a||c.build(),c.compile(e)):(f.resolve(),d||process.exit(0))};eachBuild(function(a,c,d){!1!==a.compile&&b.push([d,c])});e(0);return f};
var cp=require("child_process"),passthru=function(d,a){var c=cp.spawn(d,a),b=new Promise;c.stdout.pipe(process.stdout);c.stderr.pipe(process.stderr);process.stdin.pipe(c.stdin);c.on("exit",function(a){process.stdin.unpipe(c.stdin);0==a?b.resolve():b.reject(a)});return b},Git=function(d){this.location=d};
Git.prototype={location:null,hasChanges:function(){var d=new Promise,a=this.location,c=isDir(a+"/src")?"./src":".";process.chdir(a);cp.execFile("git",["status",c],function(a,c){a?d.reject(a):d.resolve(-1!=c.indexOf("modified:"))});return d},addAll:function(){process.chdir(this.location);return passthru("git",["add","-A","."])},commit:function(d){process.chdir(this.location);return passthru("git",["commit","-m",d])},setTag:function(d){process.chdir(this.location);return passthru("git",["tag",d])},
push:function(d,a){process.chdir(this.location);return passthru("git",["push",d,a])}};
var parseArgs=require("minimist"),Project=function(){var d=function(a,b){a=a.split(".");2==a.length?a.push("0"):a[2]=""+(parseInt(a[2],10)+b);return a.join(".")},a=function(a){this.location=a;this.name=path.basename(a);this.git=new Git(a);this.config=require(a+"/metaphorjs.json");this.hasNpm=isFile(a+"/package.json")&&!1!==this.config.npm;this.hasBower=isFile(a+"/bower.json")};a.prototype={location:null,name:null,git:null,hasNpm:!1,hasBower:!1,config:null,test:function(){var a=this,b=a.config.test,
d=[],g=new Promise,e=function(){var b=d.shift();b?(process.chdir(a.location),passthru(b.cmd,b.args||[]).then(e,e)):g.resolve()};b?(console.log("Testing "+path.basename(a.location)),d=b.cmd?[b]:b,e()):g.resolve();return g},publish:function(a){!0===a.v&&(a.v=1);var b=this,d=b.git,g=new Promise,e=a.v&&a.m?parseInt(a.v,10):null,k=!1,l=null,m=function(a){k&&null!==e&&b.setVersion(-e);g.reject(a)};d.hasChanges().fail(m).then(function(d){if(d){console.log("\n\n");console.log(b.name+" has changes");try{process.chdir(b.location),
Builder.buildAll()}catch(e){g.reject(e)}return!1!==a.test?b.test():!0}return g.resolve()}).then(function(){return g.isPending()&&!1!==a.compile?(process.chdir(b.location),Builder.compileAll(!0,!0).fail(m)):!0}).then(function(){g.isPending()&&e&&(l=b.setVersion(e),k=!0)}).then(function(){return g.isPending()?(console.log("adding changes to git"),d.addAll().fail(m)):!0}).then(function(){return g.isPending()&&a.m?(console.log("committing changes with message "+a.m),d.commit(a.m).fail(m)):g.resolve()}).then(function(){return g.isPending()&&
e?(console.log("setting git tag "+l),d.setTag(l).fail(m)):!0}).then(function(){if(g.isPending()&&a.p){console.log("publishing to git");var e=[],k=b.config.push;if(k)return k.forEach(function(a){var b;"string"==typeof a?b="--all":(b=a[1],a=a[0]);e.push(function(a,b){return function(){console.log("pushing "+b+" to "+a);return d.push(a,b)}}(a,b));e.push(function(a){return function(){console.log("sending tags to "+a);return d.push(a,"--tags")}}(a))}),Promise.waterfall(e)}return g.resolve()}).then(function(){return g.isPending()&&
e&&b.hasNpm?(console.log("publishing npm"),b.publishNpm().fail(m)):g.resolve()}).then(function(){g.resolve()});return g},setVersion:function(a){var b=this.location+"/metaphorjs.json",f=this.location+"/package.json",g=this.location+"/bower.json",e=require(b),k=e.version;console.log(k,"->",k=d(k,a));e.version=k;fs.writeFileSync(b,JSON.stringify(e,null,"    "));this.hasNpm&&(a=require(f),a.version=k,fs.writeFileSync(f,JSON.stringify(a,null,"    ")));this.hasBower&&(f=require(g),f.version=k,fs.writeFileSync(g,
JSON.stringify(f,null,"    ")));return k},publishNpm:function(){process.chdir(this.location);return passthru("npm",["publish"])}};a.testAll=function(){var c=[],b,d;eachProject(function(a,b){c.push(path.dirname(b))});var g=function(){(b=c.shift())?(d=new a(b),d.test().then(g,function(){process.exit()})):process.exit(0)};g()};a.publishAll=function(){var c=parseArgs(process.argv.slice(2),{boolean:!0}),b=[],d,g;eachProject(function(a,c){b.push(path.dirname(c))});var e=function(){(d=b.shift())?(g=new a(d),
g.publish(c).then(e,function(a){console.log("Project "+d+" failed with reason: ",a);process.exit()})):process.exit(0)};e()};return a}();MetaphorJs.Build=Build;MetaphorJs.Builder=Builder;MetaphorJs.File=File;MetaphorJs.JsonFile=JsonFile;MetaphorJs.Git=Git;MetaphorJs.Project=Project;module.exports=MetaphorJs;
