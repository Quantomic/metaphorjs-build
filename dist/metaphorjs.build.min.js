'use strict';var MetaphorJs={},toString=Object.prototype.toString,undf=void 0,varType=function(){var d={"[object String]":0,"[object Number]":1,"[object Boolean]":2,"[object Object]":3,"[object Function]":4,"[object Array]":5,"[object RegExp]":9,"[object Date]":10};return function(a){if(!a){if(null===a)return 6;if(a===undf)return 7}var c=d[toString.call(a)];return c===undf?-1:1==c&&isNaN(a)?8:c}}();function isString(d){return"string"==typeof d||d===""+d}
function isArray(d){return"object"==typeof d&&5===varType(d)}
var fs=require("fs"),path=require("path"),JsonFile=function(){var d=function(b,a){return b.replace(/@{([^}]+)}/ig,function(b,c){return a[c]?a[c]:""})},a=function(b,c){var e,k,h;for(e in b)if(k=b[e],isString(k))b[e]=d(k,c);else if(isArray(k))for(h=0,k=k.length;h<k;h++)a(b[e][h],c);else k&&"object"==typeof k&&a(b[e],c)},c=function(b){this.path=path.normalize(b);this.base=path.dirname(this.path)+"/";this.build={};this.test=[];this.push=[];this.mixin={};b=require(this.path);var c;a(b,b);for(c in b)this[c]=
b[c]};c.prototype={path:null,base:null,target:null,compile:!0,test:null,version:null,push:null,mixin:null,build:null};var b={};c.get=function(a){a=path.normalize(a);b[a]||(b[a]=new c(a));return b[a]};return c}(),isDir=function(d){return fs.existsSync(d)&&fs.lstatSync(d).isDirectory()},resolvePath=function(d,a){if(0!==d.indexOf("./")&&0!==d.indexOf("../")&&-1==d.indexOf("*")&&-1==d.indexOf("/")&&d.indexOf(".js")!=d.length-3)return!0;a=a||[];process.env.METAPHORJS_PATH&&a.push(process.env.METAPHORJS_PATH);
process.env.NODE_PATH&&(a=a.concat(process.env.NODE_PATH.split(path.delimiter)));for(var c=d,b,f,g,e=!1;-1!=(b=c.indexOf("*"));)c=c.substr(0,b),c=c.split("/"),c.pop(),c=c.join("/"),e=!0;b=0;for(f=a.length;b<f;b++)if(g=a[b],"/"!=g.substr(g.length-1)&&(g+="/"),fs.existsSync(g+c)&&(e||!isDir(g+c)))return path.normalize(g+c)+d.replace(c,"");try{var k=require.resolve(d);return k==d?!0:k}catch(h){}return!1},File=function(){var d=/'use strict'|"use strict";?/g,a=/([^\s]+)\s*=\s*require\(['|"]([^)]+)['|"]\)\s*,?/,
c=/[^=\s]?\s*(require\(['|"]([^)]+)['|"]\);?)/,b=/var[\s|,]*;/g,f=/var\s+/g,g=/,\s*;/g,e={},k=function(b){e[b]||(e[b]=new h(b));return e[b]},h=function(b,a){this.base=path.dirname(b)+"/";this.path=b;this.as=[];this.requires=[];this.requiredBy=[];this.reqNames={};this.temporary=a;this.process();this.findUnused()};h.prototype={base:null,path:null,content:"",as:null,requires:null,requiredBy:null,processed:!1,reqNames:null,temporary:!1,getContent:function(b){var a=this.content,c=this.as.slice(),e,f;b=
b||{};b.keepExports||-1==a.indexOf("module.exports")||(b.returnExports?a=a.replace(/module\.exports\s*=/,"return"):(b=(f=/module\.exports\s*=\s*([^(\['"+. ]+)\s*;/.exec(a))?f[1]:null,f=(f=/module\.exports\s*=\s*function\s+([^( ]+)/i.exec(a))?f[1]:null,b&&-1!=(e=c.indexOf(b))&&c.splice(e,1),b&&0==c.length?a=a.replace(/module\.exports\s*=\s*[^;]+;/,""):0==c.length||f&&1==c.length&&c[0]==f?a=a.replace(/module\.exports\s*=\s*/,""):1<c.length?(a="var "+c.join(", ")+";\n"+a,a=a.replace("module.exports",
c.join(" = "))):a=a.replace("module.exports","var "+c[0])),a=a.replace(d,""));return a},process:function(){var d=fs.readFileSync(this.path).toString(),f=this.base,e=0,m,h;if(!this.processed){for(;h=a.exec(d.substr(e));)if(m=resolvePath(h[2],[f]),!0===m)e+=h.index+h[2].length;else{if(!1===m)throw h[2]+" required in "+this.path+" does not exist";d=d.replace(h[0],"");this.reqNames[h[1]]=m;m=k(m);m.addAs(h[1]);if(m.doesRequire(this.path))throw"Two files require each other: "+m.path+" <-> "+this.path;
this.addRequired(m.path);m.addRequiredBy(this.path)}d=d.replace(b,"");d=d.replace(g,";");for(e=0;h=c.exec(d.substr(e));)if(m=resolvePath(h[2],[f]),!0===m)e+=h[2].length;else{if(!1===m)throw h[2]+" required in "+this.path+" does not exist";d=d.replace(h[1],"");m=k(m);if(m.doesRequire(this.path))throw"Two files require each other: "+m.path+" <-> "+this.path;this.addRequired(m.path);m.addRequiredBy(this.path)}this.content=d;this.processed=!0}},doesRequire:function(b){return-1!=this.requires.indexOf(b)},
addRequired:function(b){-1==this.requires.indexOf(b)&&this.requires.push(b)},addRequiredBy:function(b){this.requiredBy.push(b)},addAs:function(b){if("*"==b&&(b=path.basename(this.path,".js"),-1!=b.indexOf(".")))return;b&&-1==this.as.indexOf(b)&&this.as.push(b)},findUnused:function(){var b=this.content,a,c;for(a in this.reqNames)c=new RegExp("[^a-zA-Z0-9]"+a+"[^a-zA-Z0-9]"),b.match(c)||console.log("Unused requirement "+a+" in "+this.path)}};h.getOrCreate=k;h.exists=function(b){return!!e[b]};h.get=
function(b){return e[b]};h.removeDupReqs=function(c){for(var d,e,h=0,k={};d=a.exec(c.substr(h));)e=d[1],k[e]?c=c.substr(0,h+d.index)+c.substr(h+d.index+d[0].length):(k[e]=!0,h+=d.index+d[0].length);c=c.replace(b,"");c=c.replace(g,";");return c=c.replace(f,"var ")};return h}(),isFile=function(d){return fs.existsSync(d)&&fs.lstatSync(d).isFile()},getFileList=function(d,a){var c,b,f=0,g=[];if(!d)return[];"*"==d.substr(d.length-1)&&f++;"**"==d.substr(d.length-2)&&f++;f&&(d=d.substr(0,d.length-(f+1)));
d=path.normalize(d);var e=function(d){c=fs.readdirSync(d);c.forEach(function(c){b=path.normalize(d+"/"+c);isFile(b)?a?"string"==typeof a&&path.extname(b).substr(1)==a?g.push(b):path.extname(b).substr(1).match(a)&&g.push(b):g.push(b):isDir(b)&&1<f&&e(b)})};0<f||isDir(d)?e(d):g=[d];return g},Build=function(d,a){this.name=a;this.jsonFile=d;this.files=[];this.fileOptions={};var c="string"==typeof a?d.build[a]||d.mixin[a]:a,b;if(c){for(b in c)this[b]=c[b];this.collectFiles(c);this.prepareBuildList()}};
Build.prototype={name:null,jsonFile:null,files:null,buildList:null,wrap:!1,target:"",specificTarget:null,compile:!0,allOmits:null,allReplaces:null,fileOptions:null,collectFiles:function(d){var a={},c=[],b={},f={},g=function(b,c,d){if(a[b]){var e=a[b];if(e){var f,h;for(f in c)"undefined"==typeof e[f]?e[f]=c[f]:"as"==f&&(h=e[f],"string"==typeof h&&(e[f]=[h]),e[f].push(c[f]))}else a[b]=c}else a[b]=c||{};d&&(a[b].temporary=!0)},e=function(b,a,c){a=b.build[a]||b.mixin[a];var d=a.extension||"js",d="/tmp/mjs-build-tmp-"+
(new Date).getTime()+"."+d,e=require,f="undefined"==typeof f?e("./Builder.js"):f;a.specificTarget=d;(new f(a,b)).build();g(d,c)},k=function(a,c,d){d=a.files||[];var e=a.omit||[],g=a.replace||[],l=c.base,n=a.extension||"js";(a.mixins||[]).forEach(function(b){if("string"==typeof b)k(c.mixin[b]||{},c);else{var a=JsonFile.get(resolvePath(b[0],[l]));k(a.mixin[b[1]]||{},a)}});e.forEach(function(a){getFileList(resolvePath(a,[l]),n).forEach(function(a){b[a]=!0})});g.forEach(function(b){f[resolvePath(b[0],
[l])]=resolvePath(b[1],[l])});d.forEach(function(b){h(b,c)})},h=function(b,a){"string"==typeof b&&(b=[b]);var c=b[0],d;-1==c.indexOf(".")&&-1==c.indexOf("*")?b[1]?e(a,c,b[1]):k(a.mixin[c]||{},a):".json"==path.extname(c)?(c=JsonFile.get(resolvePath(c,[a.base])),b[2]?e(c,b[1],b[2]):k(c.mixin[b[1]]||{},c)):(d=path.extname(c).substr(1)||a.extension||"js",getFileList(resolvePath(c,[a.base]),d).forEach(function(a){g(a,b[1])}))};k(d,this.jsonFile);for(var l in a){for(;f[l];)l=f[l];b[l]||(c.push([l,a[l]||
{}]),a[l]&&(this.fileOptions[l]=a[l]))}this.allOmits=b;this.allReplaces=f;this.files=c},prepareBuildList:function(){var d=[],a={},c=[],b=this.allOmits,f=this.allReplaces,g=function(e){c.push(e.path);if(50<c.length)throw console.log(c),"Recursive requirement";e.requires.forEach(function(a){for(;f[a];)a=f[a];b[a]||g(File.get(a))});a[e.path]||(a[e.path]=!0,d.push(e.path));c.pop()};this.files.forEach(function(b){g(File.getOrCreate(b[0]))});var e=this.fileOptions;d.forEach(function(b){var a=e[b],c;a&&
a.as&&(c=File.getOrCreate(b),"string"==typeof a.as?c.addAs(a.as):a.as.forEach(function(b){c.addAs(b)}))});this.buildList=d}};
var eachProject=function(d){var a=process.cwd(),c=fs.readdirSync(a),b,f,g=function(c){c=c?a+"/"+c:a;b=c+"/metaphorjs.json";isDir(c)&&isFile(b)&&(f=require(b),d(f,b))};g("");c.forEach(g)},child=require("child_process"),Promise=require("metaphorjs-promise"),Builder=function(d,a){if(!(isFile(a)||a instanceof JsonFile))throw a+" not found";this.jsonFile=a instanceof JsonFile?a:JsonFile.get(a);this.projectFile=a instanceof JsonFile?a.path:a;this.bld=new Build(this.jsonFile,d)};
Builder.prototype={jsonFile:null,bld:null,projectFile:null,build:function(){var d=this.bld;d.files.length&&d.target&&this.concat()},concat:function(){var d=this,a=d.bld,c=a.specificTarget||path.normalize(d.jsonFile.base+a.target),b="",f,g;console.log("Building "+path.basename(c));isFile(c)&&fs.unlinkSync(c);if(a.require){var e=a.require,k;for(k in e){var h=e[k];if("string"==typeof h)b+="var "+h+" = require('"+k+"');\n";else{var l="var "+h.as+" = require('"+k+"')",p=h.args?h.args.join(", "):"";h.call?
l=!0===h.call?l+("("+p+")"):l+("."+h.call+"("+p+")"):p&&(l+="("+p+")");b+=l+";\n"}}}a.prepend&&a.prepend.forEach(function(a){a=path.normalize(d.jsonFile.base+a);b+=fs.readFileSync(a).toString();b+="\n"});a.buildList.forEach(function(c){if(!File.exists(c))throw c+" was not resolved";f=File.get(c);g=a.fileOptions[c];b+=f.getContent(g);b+="\n";g&&g.temporary&&fs.unlinkSync(f.path)});if(a.expose){var t={},m=a.exposeIn||"MetaphorJsExports",b=b+("var "+m+" = {};\n");if("all"==a.expose)d.collectNames().forEach(function(c){a.exposeSkip&&
-1!=bls.exposeSkip.indexOf(c)||c!=m&&(b+=m+"['"+c+"'] = "+c+";\n")});else{var q,r;a.expose.forEach(function(a){"string"==typeof a?b+=m+"['"+a+"'] = "+a+";\n":(isArray(a)?(q=a[0],r=a[2]||a[1],a=a[1]):(q=a.ns||m,r=a.as||a.name,a=a.name),t[q]||(b+=q+" || ("+q+" = {});\n"),b+=q+"['"+r+"'] = "+a+";\n")})}}a.append&&a.append.forEach(function(a){a=path.normalize(d.jsonFile.base+a);b+=fs.readFileSync(a).toString();b+="\n"});a.global&&(b+="typeof global != \"undefined\" ? (global['MetaphorJs'] = "+m+") : (window['MetaphorJs'] = "+
m+");\n");a.exports&&(!0===a.exports&&(a.exports=m),b=a.wrap?b+("return "+a.exports+";\n"):b+("module.exports = "+a.exports+";\n"));a.returns&&(b+="return "+a.returns+";\n");if(a.define){e=a.define.deps;k=a.define.return;var h='define("'+a.define.name+'", ',l="\n});\n",p=[],s=[],n;if(e){for(n in e)p.push("'"+n+"'"),s.push(e[n]);h+="["+p.join(", ")+"], ";h+="function("+s.join(", ")+") {\n"}else h+="function() {\n";k&&(l="\nreturn "+k+";"+l);b=h+b+l;b+="\n"}b=File.removeDupReqs(b);a.wrap&&(n=a.wrap,
"object"!=typeof n&&(n={}),e="",n.args&&(e=n.args.join(", ")),k=n.name||"",b=(n.start||n.deferred?"function "+k+"("+e+') {\n"use strict";\n':"(function("+e+'){\n"use strict";\n')+b+(n.end||n.deferred?"\n};":"\n}("+e+"));"),a.exports||n.exported)&&(b="module.exports = "+b);fs.writeFileSync(c,b)},compile:function(d){var a=this.bld,c=path.normalize(this.jsonFile.base+a.target),b=c.replace(/\.js$/,".min.js"),f=[],g;isFile(b)&&fs.unlinkSync(b);console.log("Compiling "+path.basename(b));g=fs.createWriteStream(b);
f.push(c);f.push("--language_in=ECMASCRIPT5_STRICT");a.compileAdvanced&&f.push("--compilation_level=ADVANCED");a.compileSourceMap&&f.push("--create_source_map="+b+".map");a=child.spawn("ccjs",f);a.stderr.pipe(process.stderr);a.stdout.pipe(g);a.on("exit",function(b){d?d(b):process.exit(b)});a.on("error",function(b){console.log(b)})},collectNames:function(){var d=[],a={};this.bld.buildList.forEach(function(c){File.getOrCreate(c).as.forEach(function(b){a[b]||(a[b]=!0,d.push(b))})});return d}};
var eachBuild=function(d){eachProject(function(a,c){var b=a.build,f;if(b)for(f in b)d(b[f],c,f)})};Builder.build=function(d,a){a||(a=process.cwd()+"/metaphorjs.json");var c=[];if(d)c.push(d);else{var b=require(a).build;if(b)for(var f in b)b[f].auto&&c.push(f)}c.forEach(function(b){(new Builder(b,a)).build()})};Builder.buildAll=function(d){var a;eachBuild(function(c,b,f){if(!d||c.auto)a=new Builder(f,b),a.build()})};
Builder.compile=function(d,a){a||(a=process.cwd()+"/metaphorjs.json");if(!d)throw"Must specify build. Or use mjs-compile --all";var c=new Promise,b=new Builder(d,a);b.build();b.compile(function(){c.resolve()});return c};
Builder.compileAll=function(d,a){var c,b=[],f=new Promise,g,e=function(k){0!=k?(f.reject(g[1]+" failed compiling with code "+k),d||process.exit(k)):(g=b.shift())?(c=new Builder(g[0],g[1]),a||c.build(),c.compile(e)):(f.resolve(),d||process.exit(0))};eachBuild(function(a,c,d){!1!==a.compile&&b.push([d,c])});e(0);return f};
var cp=require("child_process"),passthru=function(d,a){var c=cp.spawn(d,a),b=new Promise;c.stdout.pipe(process.stdout);c.stderr.pipe(process.stderr);process.stdin.pipe(c.stdin);c.on("exit",function(a){process.stdin.unpipe(c.stdin);0==a?b.resolve():b.reject(a)});return b},Git=function(d){this.location=d};
Git.prototype={location:null,hasChanges:function(d){var a=new Promise,c=this.location;d=d?".":isDir(c+"/src")?"./src":".";process.chdir(c);cp.execFile("git",["status",d],function(b,c){b?a.reject(b):a.resolve(-1!=c.indexOf("modified:")||-1!=c.indexOf("Untracked files:"))});return a},addAll:function(){process.chdir(this.location);return passthru("git",["add","-A","."])},commit:function(d){process.chdir(this.location);return passthru("git",["commit","-m",d])},setTag:function(d){process.chdir(this.location);
return passthru("git",["tag",d])},push:function(d,a){process.chdir(this.location);return passthru("git",["push",d,a])}};
var parseArgs=require("minimist"),Project=function(){var d=function(a,b){a=a.split(".");2==a.length?a.push("0"):a[2]=""+(parseInt(a[2],10)+b);return a.join(".")},a=function(a){this.location=a;this.name=path.basename(a);this.git=new Git(a);this.config=require(a+"/metaphorjs.json");this.hasNpm=isFile(a+"/package.json")&&!1!==this.config.npm;this.hasBower=isFile(a+"/bower.json");this.npmJson=this.hasNpm?require(a+"/package.json"):null;this.bowerJson=this.hasBower?require(a+"/bower.json"):null};a.prototype=
{location:null,name:null,git:null,hasNpm:!1,hasBower:!1,config:null,test:function(){var a=this,b=a.config.test,d=[],g=new Promise,e=function(){var b=d.shift();b?(process.chdir(a.location),passthru(b.cmd,b.args||[]).then(e,e)):g.resolve()};b?(console.log("Testing "+path.basename(a.location)),d=b.cmd?[b]:b,e()):g.resolve();return g},publish:function(a){!0===a.v&&(a.v=1);var b=this,d=b.git,g=new Promise,e=a.v&&a.m?parseInt(a.v,10):null,k=!1,h=null,l=function(a){k&&null!==e&&b.setVersion(-e);g.reject(a)};
d.hasChanges(!0===a.w).fail(l).then(function(d){if(d){console.log("\n\n");console.log(b.name+" has changes");try{process.chdir(b.location),Builder.buildAll()}catch(e){g.reject(e)}return!1!==a.test?b.test():!0}return g.resolve()}).then(function(){return g.isPending()&&!1!==a.compile?(process.chdir(b.location),Builder.compileAll(!0,!0).fail(l)):!0}).then(function(){g.isPending()&&(b.syncPackageFiles(),e&&(h=b.setVersion(e),k=!0))}).then(function(){return g.isPending()?(console.log("adding changes to git"),
d.addAll().fail(l)):!0}).then(function(){return g.isPending()&&a.m?(console.log("committing changes with message "+a.m),d.commit(a.m).fail(l)):g.resolve()}).then(function(){return g.isPending()&&e?(console.log("setting git tag "+h),d.setTag(h).fail(l)):!0}).then(function(){if(g.isPending()&&a.p||a.forcePush){console.log("publishing to git");var e=[],h=b.config.push;if(h)return h.forEach(function(a){var b;"string"==typeof a?b="--all":(b=a[1],a=a[0]);e.push(function(a,b){return function(){console.log("pushing "+
b+" to "+a);return d.push(a,b)}}(a,b));e.push(function(a){return function(){console.log("sending tags to "+a);return d.push(a,"--tags")}}(a))}),Promise.waterfall(e)}return g.resolve()}).then(function(){return g.isPending()&&e&&b.hasNpm?(console.log("publishing npm"),b.publishNpm().fail(l)):g.resolve()}).then(function(){g.resolve()});return g},syncPackageFiles:function(){var a=this.location+"/package.json",b=this.location+"/bower.json";this.hasNpm&&(this.npmJson.description=this.config.description,
fs.writeFileSync(a,JSON.stringify(this.npmJson,null,"    ")));this.hasBower&&(this.bowerJson.description=this.config.description,fs.writeFileSync(b,JSON.stringify(this.bowerJson,null,"    ")))},setVersion:function(a){var b=this.location+"/metaphorjs.json",f=this.location+"/package.json",g=this.location+"/bower.json",e=require(b).version;console.log(e,"->",e=d(e,a));this.config.version=e;fs.writeFileSync(b,JSON.stringify(this.config,null,"    "));this.hasNpm&&(this.npmJson.version=e,fs.writeFileSync(f,
JSON.stringify(this.npmJson,null,"    ")));this.hasBower&&(this.bowerJson.version=e,fs.writeFileSync(g,JSON.stringify(this.bowerJson,null,"    ")));return e},publishNpm:function(){process.chdir(this.location);return passthru("npm",["publish"])}};a.testAll=function(){var c=[],b,d;eachProject(function(a,b){c.push(path.dirname(b))});var g=function(){(b=c.shift())?(d=new a(b),d.test().then(g,function(){process.exit()})):process.exit(0)};g()};a.publishAll=function(){var c=parseArgs(process.argv.slice(2),
{boolean:!0}),b=[],d,g;eachProject(function(a,c){b.push(path.dirname(c))});var e=function(){(d=b.shift())?(g=new a(d),g.publish(c).then(e,function(a){console.log("Project "+d+" failed with reason: ",a);process.exit()})):process.exit(0)};e()};return a}(),MetaphorJsExports={};MetaphorJsExports.Build=Build;MetaphorJsExports.Builder=Builder;MetaphorJsExports.File=File;MetaphorJsExports.JsonFile=JsonFile;MetaphorJsExports.Git=Git;MetaphorJsExports.Project=Project;module.exports=MetaphorJsExports;
